@using Store.Data.Models
@model Store.ViewModels.ProductListViewModel

<nav class="pt-3 my-3 my-md-3 justify-content-center" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Home")" class="text-color">Главная</a>
        </li>
        <li class="breadcrumb-item active text-color" aria-current="page">
            Каталог товаров
        </li>
    </ol>
</nav>

<!-- Форма поиска -->
<div class="row mb-3">
    <div class="col-md-4 col-sm-6 mb-2">
        <form method="get" action="@Url.Action("Index", "Product")">
            <div class="position-relative">
                <input type="search" name="SearchTerm" class="rounded-pill form-control bg-custom text-custom" placeholder="Поиск..." style="padding-right: 40px; height: calc(1.5em + 1rem + 2px);">
                <button type="submit" class="btn btn-icon btn-sm fs-lg rounded-circle position-absolute top-0 end-0 mt-1 me-1 bg-custom text-custom" aria-label="Поиск">
                    <i class="ci-arrow-right text-custom"></i>
                </button>
            </div>
        </form>
    </div>
</div>




<form method="get" action="@Url.Action("List", "Product")">
    <div class="row mb-4">
        <!-- Фильтр по категориям -->
        <div class="col-md-3">
            <label for="categoryFilter">Категория:</label>
            <select name="categoryId" id="categoryFilter" class="form-select">
                <option value="">Все категории</option>
                @foreach (var category in Model.Categories)
                {
                    <option value="@category.Id" @(Model.SelectedCategoryId == category.Id ? "selected" : "")>
                        @category.Name
                    </option>
                }
            </select>
        </div>

        <!-- Фильтр по типу продукта -->
        <div class="col-md-3">
            <label for="productTypeFilter">Тип продукта:</label>
            <select name="productType" id="productTypeFilter" class="form-select">
                <option value="">Все типы</option>
                @foreach (var type in Enum.GetValues(typeof(ProductType)))
                {
                    <option value="@type" @(Model.SelectedProductType == type.ToString() ? "selected" : "")>
                        @type
                    </option>
                }
            </select>
        </div>

        <!-- Фильтр по материалу -->
        <div class="col-md-3">
            <label for="materialFilter">Материал:</label>
            <select name="material" id="materialFilter" class="form-select">
                <option value="">Все материалы</option>
                @foreach (var material in Model.Materials)
                {
                    <option value="@material" @(Model.SelectedMaterial == material ? "selected" : "")>
                        @material
                    </option>
                }
            </select>
        </div>

        <!-- Фильтр по стране -->
        <div class="col-md-3">
            <label for="countryFilter">Страна:</label>
            <select name="country" id="countryFilter" class="form-select">
                <option value="">Все страны</option>
                @foreach (var country in Model.Countries)
                {
                    <option value="@country" @(Model.SelectedCountry == country ? "selected" : "")>
                        @country
                    </option>
                }
            </select>
        </div>

        <!-- Фильтр по цене -->
        <div class="col-md-3">
            <label for="priceMin">Цена от:</label>
            <input type="number" name="priceMin" id="priceMin" class="form-control" value="@Model.PriceMin" placeholder="Минимальная цена" />
        </div>

        <div class="col-md-3">
            <label for="priceMax">Цена до:</label>
            <input type="number" name="priceMax" id="priceMax" class="form-control" value="@Model.PriceMax" placeholder="Максимальная цена" />
        </div>

        <div class="col-md-3 mt-3">
            <button type="submit" class="btn btn-custom">Применить фильтры</button>
        </div>
    </div>
</form>



<div class="row">
    @if (Model.Products != null && Model.Products.Any())
    {
        foreach (var product in Model.Products)
        {
            <div class="col-md-4 mb-4">
                <div class="card h-100 productCard">
                    <!-- Карусель изображений продукта -->
                    @if (product.Images != null && product.Images.Any())
                    {
                        <div id="carousel-@product.Id" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner product-images">
                                @{
                                    int imageIndex = 0;
                                    foreach (var image in product.Images)
                                    {
                                        var isActive = imageIndex == 0 ? "active" : "";
                                        <div class="carousel-item @isActive">
                                            <!-- Оборачиваем изображение в ссылку на страницу Details -->
                                            <a href="@Url.Action("Details", "Product", new { id = product.Id })">
                                                <img src="@image.Url" alt="@product.Name" />
                                            </a>
                                        </div>
                                        imageIndex++;
                                    }
                                }
                            </div>

                            <!-- Стрелки навигации -->
                            @if (product.Images.Count() > 1)
                            {
                                <button class="carousel-control-prev" type="button" data-bs-target="#carousel-@product.Id" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Предыдущий</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carousel-@product.Id" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Следующий</span>
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <a href="@Url.Action("Details", "Product", new { id = product.Id })">
                            <img src="/images/placeholder.png" class="card-img-top imgCard product-images" alt="Изображение не найдено">
                        </a>
                    }
                    <div class="card-body">
                        <h5 class="card-title">@product.Name</h5>

                        <!-- Форма для выбора размера -->
                        @using (Html.BeginForm("List", "Product", FormMethod.Get, new { @id = "sizeForm-" + product.Id }))
                        {
                            <input type="hidden" name="productId" value="@product.Id" />
                            <div class="form-group">
                                <label for="size-selector-@product.Id">Выберите размер:</label>
                                <select id="size-selector-@product.Id" name="selectedSizeId" class="form-select" onchange="document.getElementById('sizeForm-@product.Id').submit();">
                                    @foreach (var variation in product.Variations)
                                    {
                                        var isSelected = Model.SelectedVariations.ContainsKey(product.Id) && Model.SelectedVariations[product.Id].Id == variation.Id;
                                        <option value="@variation.Id" @(isSelected ? "selected" : "")>
                                            @variation.Size
                                        </option>
                                    }
                                </select>
                            </div>
                        }

                        <!-- Отображение цены -->
                        @{
                            Variation selectedVariation;
                            if (Model.SelectedVariations.ContainsKey(product.Id))
                            {
                                selectedVariation = Model.SelectedVariations[product.Id];
                            }
                            else
                            {
                                selectedVariation = product.Variations.First();
                            }
                        }

                        <p class="card-text">
                            <strong>Цена: </strong>
                            @if (selectedVariation.DiscountedPrice.HasValue)
                            {
                                <strong style="text-decoration: line-through;">
                                    @selectedVariation.Price.ToString("N2") ₽
                                </strong>
                                <strong class="text-success">
                                    @selectedVariation.DiscountedPrice.Value.ToString("N2") ₽
                                </strong>
                            }
                            else
                            {
                                <strong>@selectedVariation.Price.ToString("N2") ₽</strong>
                            }
                        </p>

                        <!-- Кнопки действий -->
                        <a href="#" class="btn btn-custom">В корзину</a>
                        <a href="#" class="btn btn-custom">Оформить сейчас</a>
                        <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="btn btn-custom">Подробнее</a>

                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <p>Нет доступных продуктов.</p>
    }
</div>
